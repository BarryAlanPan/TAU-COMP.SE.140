worker_processes 1;

events {
    worker_connections 1024;
}

http {

    upstream service1_backend {
        server service1-1:8199;
        server service1-2:8199;
        server service1-3:8199;
    }

    server {
        listen 80;
        server_name localhost;
        
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
            root /usr/share/nginx/html;
            index index.html;
        }

        location /data {
            proxy_pass http://service1_backend/;
        }

        location /stop {
            default_type text/plain;
            content_by_lua_block {
                local result = os.execute("/usr/local/openresty/scripts/stop.sh")
                if result then
                    ngx.say("Stopping services...")
                else
                    ngx.say("Failed to stop services")
                    ngx.log(ngx.ERR, "Failed to execute stop script")
                end
            }
        }
    }

    server {
        listen 8197;
        server_name localhost;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
            proxy_pass http://service1_backend/;
        }

        location /stop {
            default_type text/plain;
            content_by_lua_block {
                local result = os.execute("/usr/local/openresty/scripts/stop.sh")
                if result then
                    ngx.say("Stopping services...")
                else
                    ngx.say("Failed to stop services")
                    ngx.log(ngx.ERR, "Failed to execute stop script")
                end
            }
        }
    }
}